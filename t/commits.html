<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html>
{{template "stdhead" git.Head.Branch.Name}}
<body>
{{template "navbar" $}}

{{$notes := gitnotes}}


<ul class="collapsible" data-collapsible="expandable">
{{range gitlog}}
 <li>
      <div class="collapsible-header {{if eq .Id.String git.Head.Target.String}}active{{end}}">{{.Id.String | shortid}} {{.Summary}}</div>
      <div class="collapsible-body">
      	<div class="row">
      		<div class="col s1">Author</div> {{template "sig" .Author}}
      	</div>
      	<div class="row">
   			<div class="col s1">Committer</div> {{template "sig" .Committer}}
   		</div>
      	<div class="row">
	      	<div class="col s12">{{.Message}}</div>
      	</div>
{{with .Id.String | index $notes}}
      	<div class="row">
	      	<div class="col s12"><pre>{{.}}</pre></div>
      	</div>
{{end}}
{{if eq .Id.String git.Head.Target.String}}
		<div class="row">
		    <form class="col s12">
		    	<input type="hidden" name="commit" value="{{.Id}}">
				<div class="row">
					<div class="input-field col s12">
						<i class="material-icons prefix">mode_edit</i>
						<textarea id="textarea1" name="text" class="materialize-textarea"></textarea>
						<label for="textarea1">New Comment</label>
					</div>
				</div>
				<div class="row">
					<div class="input-field col s2">
					<button class="btn waves-effect waves-light" type="submit">Submit<i class="material-icons right">send</i>
					</button>
					</div>
				</div>
			</form>
		</div>
      </div>
{{end}}
    </li>
    <li>
<li>
{{end}}
</ul>
{{define "sig"}}
	<div class="col s2">{{.Name}} &lt;{{.Email}}&gt</div>
	<div class="col s2">{{.When | timestamp}}</div>
{{end}}

<script>
$(document).ready(function() {
    $("form").submit(function(ev){
        ev.preventDefault();
        var data = $(this).serializeArray().reduce(function(obj, item) {
		    obj[item.name] = item.value;
    		return obj;
		}, {});
        $.ajax({
			type:    'POST',
			url:     '/api/v1/commits/' + data['commit'] + '/notes',
			//data:    data['text'],
			data:    $(this).serializeArray(),
			success: function(res, status, xhr) { location.reload(); },
			error:   function(xhr, status, err) { Materialize.toast(xhr.responseText, 4000); }
        });
    });
});
</script>
</body>
</html>